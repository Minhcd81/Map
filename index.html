<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£n ƒë·ªì Quy ho·∫°ch & Gi√° ƒë·∫•t - Demo</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet Plugins CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .controls {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            position: relative;
            z-index: 999;
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-group label {
            font-weight: 500;
            color: #333;
        }

        select, input, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        button {
            background: #ff6b35;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #e55a2b;
            transform: translateY(-1px);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        #map {
            height: calc(100vh - 140px);
            width: 100%;
        }

        .info-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-width: 350px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .info-panel.show {
            transform: translateX(0);
        }

        .info-panel .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #999;
            padding: 5px;
        }

        .info-panel h3 {
            color: #333;
            margin-bottom: 15px;
            padding-right: 30px;
        }

        .info-item {
            margin-bottom: 12px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .info-item label {
            font-weight: 600;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
        }

        .info-item .value {
            font-size: 16px;
            color: #333;
            margin-top: 2px;
        }

        .price-highlight {
            color: #ff6b35;
            font-weight: bold;
            font-size: 18px;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            text-align: center;
            z-index: 2000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff6b35;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .legend {
            position: fixed;
            top: 160px;
            left: 20px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 250px;
        }

        .legend h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 8px;
            border: 1px solid #ddd;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                flex-direction: column;
                align-items: stretch;
                gap: 5px;
            }

            .legend {
                position: relative;
                left: 0;
                top: 0;
                margin: 10px;
                max-width: none;
            }

            .info-panel {
                bottom: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                transform: translateY(400px);
            }

            .info-panel.show {
                transform: translateY(0);
            }
        }

        /* Custom popup styles */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .custom-popup {
            min-width: 200px;
        }

        .custom-popup h4 {
            color: #ff6b35;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .custom-popup p {
            margin: 4px 0;
            font-size: 14px;
        }

        /* Leaflet control customization */
        .leaflet-control-container .leaflet-control {
            margin: 10px;
        }

        .leaflet-bar a {
            background: white;
            color: #333;
        }

        .leaflet-bar a:hover {
            background: #f5f5f5;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üó∫Ô∏è B·∫£n ƒë·ªì Quy ho·∫°ch & Gi√° ƒë·∫•t</h1>
        <p>H·ªá th·ªëng hi·ªÉn th·ªã th√¥ng tin quy ho·∫°ch s·ª≠ d·ª•ng ƒë·∫•t v√† gi√° b·∫•t ƒë·ªông s·∫£n</p>
    </div>

    <div class="controls">
        <div class="control-group">
            <label>üìä D·ªØ li·ªáu:</label>
            <input type="file" id="shapefileInput" accept=".geojson,.json" title="Upload GeoJSON file">
            <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" title="Upload Excel/CSV file">
        </div>
        
        <div class="control-group">
            <label>üîó Google Sheets:</label>
            <input type="text" id="sheetsUrl" placeholder="Nh·∫≠p URL Google Sheets" style="width: 300px;">
            <button onclick="loadGoogleSheets()">T·∫£i d·ªØ li·ªáu</button>
        </div>

        <div class="control-group">
            <label>üé® Hi·ªÉn th·ªã:</label>
            <select id="mapLayer">
                <option value="roadmap">B·∫£n ƒë·ªì th∆∞·ªùng</option>
                <option value="satellite">V·ªá tinh</option>
                <option value="hybrid">K·∫øt h·ª£p</option>
                <option value="terrain">ƒê·ªãa h√¨nh</option>
            </select>
            
            <button onclick="toggleLegend()">üìã Ch√∫ th√≠ch</button>
            <button onclick="exportData()">üíæ Xu·∫•t d·ªØ li·ªáu</button>
        </div>
    </div>

    <div id="map"></div>

    <!-- Legend -->
    <div class="legend" id="legend">
        <h4>Ch√∫ th√≠ch</h4>
        <div class="legend-item">
            <div class="legend-color" style="background: #ff1744;"></div>
            <span>ƒê·∫•t ·ªü ƒë√¥ th·ªã (ODT)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ffab00;"></div>
            <span>ƒê·∫•t giao th√¥ng</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #00e676;"></div>
            <span>ƒê·∫•t c√¥ng vi√™n</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #2196f3;"></div>
            <span>ƒê·∫•t th∆∞∆°ng m·∫°i</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #9c27b0;"></div>
            <span>ƒê·∫•t c√¥ng c·ªông</span>
        </div>
    </div>

    <!-- Info Panel -->
    <div class="info-panel" id="infoPanel">
        <button class="close-btn" onclick="closeInfoPanel()">&times;</button>
        <h3>Th√¥ng tin chi ti·∫øt</h3>
        <div id="infoContent">
            <p>Click v√†o m·ªôt khu v·ª±c ƒë·ªÉ xem th√¥ng tin chi ti·∫øt</p>
        </div>
    </div>

    <!-- Loading indicator -->
    <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
        <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>

    <!-- Scripts -->
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Plugins -->
    <script src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet-compass@1.0.0/dist/leaflet-compass.min.js"></script>
    
    <!-- SheetJS for Excel reading -->
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Papa Parse for CSV -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <script>
        // Global variables
        let map;
        let googleMap;
        let currentLayer;
        let drawnItems;
        let landData = [];
        let priceData = [];

        // Color mapping for land types
        const landTypeColors = {
            'ODT': '#ff1744',
            'ƒê·∫•t ·ªü ƒë√¥ th·ªã': '#ff1744',
            'GT': '#ffab00',
            'Giao th√¥ng': '#ffab00',
            'CV': '#00e676',
            'C√¥ng vi√™n': '#00e676',
            'TM': '#2196f3',
            'Th∆∞∆°ng m·∫°i': '#2196f3',
            'CC': '#9c27b0',
            'C√¥ng c·ªông': '#9c27b0'
        };

        // Initialize map
        function initMap() {
            // Initialize Leaflet map
            map = L.map('map', {
                center: [10.7769, 106.6982], // Ho Chi Minh City
                zoom: 15,
                zoomControl: false
            });

            // Add Google Maps layer
            addGoogleMapsLayer('roadmap');

            // Add custom controls
            addMapControls();

            // Initialize drawing tools
            initDrawingTools();

            // Add sample data
            loadSampleData();

            console.log('üó∫Ô∏è Map initialized successfully');
        }

        // Add Google Maps layer
        function addGoogleMapsLayer(mapType) {
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }

            currentLayer = L.tileLayer(`https://mt1.google.com/vt/lyrs=${getGoogleMapType(mapType)}&x={x}&y={y}&z={z}`, {
                attribution: '¬© Google Maps',
                maxZoom: 20
            });

            currentLayer.addTo(map);
        }

        // Get Google Maps type
        function getGoogleMapType(type) {
            const types = {
                'roadmap': 'm',
                'satellite': 's',
                'hybrid': 'y',
                'terrain': 'p'
            };
            return types[type] || 'm';
        }

        // Add map controls
        function addMapControls() {
            // Zoom control
            L.control.zoom({
                position: 'topright'
            }).addTo(map);

            // Search control
            const geocoder = L.Control.Geocoder.nominatim();
            L.Control.geocoder({
                geocoder: geocoder,
                position: 'topleft',
                placeholder: 'T√¨m ki·∫øm ƒë·ªãa ƒëi·ªÉm...',
                errorMessage: 'Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£'
            }).addTo(map);

            // Scale control
            L.control.scale({
                position: 'bottomleft',
                metric: true,
                imperial: false
            }).addTo(map);

            // Compass control (if available)
            if (L.control.compass) {
                L.control.compass({
                    position: 'topright'
                }).addTo(map);
            }

            // Custom coordinate display
            const coordControl = L.control({ position: 'bottomright' });
            coordControl.onAdd = function() {
                const div = L.DomUtil.create('div', 'coord-control');
                div.style.background = 'rgba(255,255,255,0.9)';
                div.style.padding = '5px 10px';
                div.style.borderRadius = '4px';
                div.style.fontSize = '12px';
                div.innerHTML = 'Lat: 0.0000, Lng: 0.0000';
                
                map.on('mousemove', function(e) {
                    div.innerHTML = `Lat: ${e.latlng.lat.toFixed(4)}, Lng: ${e.latlng.lng.toFixed(4)}`;
                });
                
                return div;
            };
            coordControl.addTo(map);
        }

        // Initialize drawing tools
        function initDrawingTools() {
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            const drawControl = new L.Control.Draw({
                position: 'topleft',
                draw: {
                    polygon: {
                        allowIntersection: false,
                        drawError: {
                            color: '#e1e100',
                            message: '<strong>L·ªói:</strong> Kh√¥ng th·ªÉ v·∫Ω h√¨nh giao nhau!'
                        },
                        shapeOptions: {
                            color: '#ff6b35',
                            weight: 3,
                            opacity: 0.8,
                            fillOpacity: 0.3
                        }
                    },
                    polyline: {
                        shapeOptions: {
                            color: '#ff6b35',
                            weight: 3,
                            opacity: 0.8
                        }
                    },
                    rectangle: {
                        shapeOptions: {
                            color: '#ff6b35',
                            weight: 3,
                            opacity: 0.8,
                            fillOpacity: 0.3
                        }
                    },
                    circle: {
                        shapeOptions: {
                            color: '#ff6b35',
                            weight: 3,
                            opacity: 0.8,
                            fillOpacity: 0.3
                        }
                    },
                    marker: true,
                    circlemarker: false
                },
                edit: {
                    featureGroup: drawnItems,
                    remove: true
                }
            });

            map.addControl(drawControl);

            // Handle drawing events
            map.on(L.Draw.Event.CREATED, function(e) {
                const layer = e.layer;
                
                if (e.layerType === 'polygon') {
                    calculateArea(layer);
                } else if (e.layerType === 'polyline') {
                    calculateDistance(layer);
                }
                
                drawnItems.addLayer(layer);
            });

            map.on(L.Draw.Event.EDITED, function(e) {
                const layers = e.layers;
                layers.eachLayer(function(layer) {
                    if (layer instanceof L.Polygon) {
                        calculateArea(layer);
                    } else if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)) {
                        calculateDistance(layer);
                    }
                });
            });
        }

        // Calculate area
        function calculateArea(layer) {
            const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
            const areaInSqm = area.toFixed(2);
            const areaInAcres = (area * 0.000247105).toFixed(4);
            
            layer.bindPopup(`
                <div class="custom-popup">
                    <h4>üìê Di·ªán t√≠ch</h4>
                    <p><strong>${areaInSqm} m¬≤</strong></p>
                    <p>${areaInAcres} acres</p>
                    <p>${(area / 10000).toFixed(4)} hecta</p>
                </div>
            `).openPopup();
        }

        // Calculate distance
        function calculateDistance(layer) {
            let distance = 0;
            const latlngs = layer.getLatLngs();
            
            for (let i = 0; i < latlngs.length - 1; i++) {
                distance += latlngs[i].distanceTo(latlngs[i + 1]);
            }
            
            const distanceInM = distance.toFixed(2);
            const distanceInKm = (distance / 1000).toFixed(3);
            
            layer.bindPopup(`
                <div class="custom-popup">
                    <h4>üìè Kho·∫£ng c√°ch</h4>
                    <p><strong>${distanceInM} m</strong></p>
                    <p>${distanceInKm} km</p>
                </div>
            `).openPopup();
        }

        // Load sample data
        function loadSampleData() {
            const sampleData = [
                {
                    type: 'Feature',
                    properties: {
                        name: 'Th·ª≠a 19 T·ªù 1',
                        landType: 'ODT',
                        area: 320.91,
                        pricePerSqm: 26810000,
                        totalValue: 8600000000,
                        address: 'Ph∆∞·ªùng T√¢y Th·∫°nh, Qu·∫≠n T√¢n Ph√∫',
                        ward: 'Ph∆∞·ªùng T√¢y Th·∫°nh',
                        district: 'Qu·∫≠n T√¢n Ph√∫'
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [[
                            [106.6980, 10.7769],
                            [106.6985, 10.7770],
                            [106.6987, 10.7765],
                            [106.6982, 10.7764],
                            [106.6980, 10.7769]
                        ]]
                    }
                },
                {
                    type: 'Feature',
                    properties: {
                        name: 'Th·ª≠a 22 T·ªù 1',
                        landType: 'GT',
                        area: 285.50,
                        pricePerSqm: 18500000,
                        totalValue: 5280000000,
                        address: 'Ph∆∞·ªùng T√¢y Th·∫°nh, Qu·∫≠n T√¢n Ph√∫',
                        ward: 'Ph∆∞·ªùng T√¢y Th·∫°nh',
                        district: 'Qu·∫≠n T√¢n Ph√∫'
                    },
                    geometry: {
                        type: 'Polygon',
                        coordinates: [[
                            [106.6990, 10.7775],
                            [106.6995, 10.7778],
                            [106.6997, 10.7773],
                            [106.6992, 10.7770],
                            [106.6990, 10.7775]
                        ]]
                    }
                }
            ];

            displayGeoJSON({ type: 'FeatureCollection', features: sampleData });
            console.log('üìä Sample data loaded');
        }

        // Display GeoJSON data
        function displayGeoJSON(geojsonData) {
            L.geoJSON(geojsonData, {
                style: function(feature) {
                    const landType = feature.properties.landType || feature.properties.land_type || 'ODT';
                    return {
                        fillColor: landTypeColors[landType] || '#999999',
                        weight: 2,
                        opacity: 1,
                        color: 'white',
                        dashArray: '3',
                        fillOpacity: 0.7
                    };
                },
                onEachFeature: function(feature, layer) {
                    const props = feature.properties;
                    
                    // Create popup content
                    const popupContent = createPopupContent(props);
                    layer.bindPopup(popupContent);

                    // Add click event
                    layer.on('click', function() {
                        showInfoPanel(props);
                    });

                    // Add hover effect
                    layer.on('mouseover', function() {
                        layer.setStyle({
                            weight: 3,
                            fillOpacity: 0.9
                        });
                    });

                    layer.on('mouseout', function() {
                        layer.setStyle({
                            weight: 2,
                            fillOpacity: 0.7
                        });
                    });
                }
            }).addTo(map);
        }

        // Create popup content
        function createPopupContent(props) {
            const formatPrice = (price) => {
                if (price > 1000000000) {
                    return `${(price / 1000000000).toFixed(2)} t·ª∑`;
                } else if (price > 1000000) {
                    return `${(price / 1000000).toFixed(0)} tri·ªáu`;
                } else {
                    return `${price.toLocaleString()} VNƒê`;
                }
            };

            return `
                <div class="custom-popup">
                    <h4>${props.name || props.plot_name || 'Khu v·ª±c'}</h4>
                    <p><strong>Lo·∫°i ƒë·∫•t:</strong> ${props.landType || props.land_type || 'Kh√¥ng x√°c ƒë·ªãnh'}</p>
                    <p><strong>Di·ªán t√≠ch:</strong> ${props.area || props.area_sqm || 0} m¬≤</p>
                    <p><strong>Gi√°:</strong> <span class="price-highlight">${formatPrice(props.pricePerSqm || props.price_per_sqm || 0)}/m¬≤</span></p>
                    <p><strong>ƒê·ªãa ch·ªâ:</strong> ${props.address || props.ward + ', ' + props.district || 'Kh√¥ng c√≥ th√¥ng tin'}</p>
                </div>
            `;
        }

        // Show info panel
        function showInfoPanel(props) {
            const formatPrice = (price) => {
                if (price > 1000000000) {
                    return `${(price / 1000000000).toFixed(2)} t·ª∑`;
                } else if (price > 1000000) {
                    return `${(price / 1000000).toFixed(0)} tri·ªáu`;
                } else {
                    return `${price.toLocaleString()} VNƒê`;
                }
            };

            const content = `
                <div class="info-item">
                    <label>T√™n th·ª≠a</label>
                    <div class="value">${props.name || props.plot_name || 'Kh√¥ng x√°c ƒë·ªãnh'}</div>
                </div>
                <div class="info-item">
                    <label>Lo·∫°i ƒë·∫•t</label>
                    <div class="value">${props.landType || props.land_type || 'Kh√¥ng x√°c ƒë·ªãnh'}</div>
                </div>
                <div class="info-item">
                    <label>Di·ªán t√≠ch</label>
                    <div class="value">${props.area || props.area_sqm || 0} m¬≤</div>
                </div>
                <div class="info-item">
                    <label>Gi√°/m¬≤</label>
                    <div class="value price-highlight">${formatPrice(props.pricePerSqm || props.price_per_sqm || 0)}</div>
                </div>
                <div class="info-item">
                    <label>T·ªïng gi√° tr·ªã</label>
                    <div class="value price-highlight">${formatPrice(props.totalValue || props.total_value || 0)}</div>
                </div>
                <div class="info-item">
                    <label>ƒê·ªãa ch·ªâ</label>
                    <div class="value">${props.address || (props.ward + ', ' + props.district) || 'Kh√¥ng c√≥ th√¥ng tin'}</div>
                </div>
            `;

            document.getElementById('infoContent').innerHTML = content;
            document.getElementById('infoPanel').classList.add('show');
        }

        // Close info panel
        function closeInfoPanel() {
            document.getElementById('infoPanel').classList.remove('show');
        }

        // Load Google Sheets data
        async function loadGoogleSheets() {
            const url = document.getElementById('sheetsUrl').value.trim();
            if (!url) {
                alert('Vui l√≤ng nh·∫≠p URL Google Sheets');
                return;
            }

            showLoading(true);

            try {
                // Convert Google Sheets URL to CSV export URL
                let csvUrl;
                if (url.includes('/spreadsheets/d/')) {
                    const sheetId = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/)[1];
                    csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
                } else {
                    throw new Error('URL kh√¥ng h·ª£p l·ªá');
                }

                const response = await fetch(csvUrl);
                const csvText = await response.text();

                // Parse CSV
                const results = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true
                });

                if (results.errors.length > 0) {
                    console.error('CSV parsing errors:', results.errors);
                }

                // Convert to GeoJSON
                const geojson = convertToGeoJSON(results.data);
                displayGeoJSON(geojson);

                console.log('‚úÖ Google Sheets data loaded successfully');
                alert(`ƒê√£ t·∫£i th√†nh c√¥ng ${results.data.length} b·∫£n ghi t·ª´ Google Sheets`);

            } catch (error) {
                console.error('Error loading Google Sheets:', error);
                alert('L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets. Vui l√≤ng ki·ªÉm tra URL v√† quy·ªÅn truy c·∫≠p.');
            } finally {
                showLoading(false);
            }
        }

        // Convert tabular data to GeoJSON
        function convertToGeoJSON(data) {
            const features = data
                .filter(row => row.lat && row.lng && (row.latitude && row.longitude))
                .map(row => {
                    const lat = parseFloat(row.lat || row.latitude || 0);
                    const lng = parseFloat(row.lng || row.longitude || 0);
                    
                    if (isNaN(lat) || isNaN(lng)) return null;

                    return {
                        type: 'Feature',
                        properties: {
                            ...row,
                            name: row.name || row.plot_name || row.address || 'Unnamed',
                            landType: row.landType || row.land_type || row.type || 'ODT',
                            area: parseFloat(row.area || row.area_sqm || 0),
                            pricePerSqm: parseFloat(row.pricePerSqm || row.price_per_sqm || row.price || 0),
                            totalValue: parseFloat(row.totalValue || row.total_value || 0)
                        },
                        geometry: {
                            type: 'Point',
                            coordinates: [lng, lat]
                        }
                    };
                })
                .filter(feature => feature !== null);

            return {
                type: 'FeatureCollection',
                features: features
            };
        }

        // File upload handlers
        document.getElementById('shapefileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const geojson = JSON.parse(event.target.result);
                    displayGeoJSON(geojson);
                    console.log('‚úÖ GeoJSON file loaded successfully');
                } catch (error) {
                    alert('L·ªói: File kh√¥ng ph·∫£i ƒë·ªãnh d·∫°ng GeoJSON h·ª£p l·ªá');
                }
            };
            reader.readAsText(file);
        });

        document.getElementById('excelInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            showLoading(true);

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const workbook = XLSX.read(event.target.result, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    const geojson = convertToGeoJSON(jsonData);
                    displayGeoJSON(geojson);

                    console.log('‚úÖ Excel file loaded successfully');
                    alert(`ƒê√£ t·∫£i th√†nh c√¥ng ${jsonData.length} b·∫£n ghi t·ª´ file Excel`);
                } catch (error) {
                    alert('L·ªói khi ƒë·ªçc file Excel: ' + error.message);
                } finally {
                    showLoading(false);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // Map layer change handler
        document.getElementById('mapLayer').addEventListener('change', function(e) {
            addGoogleMapsLayer(e.target.value);
        });

        // Toggle legend
        function toggleLegend() {
            const legend = document.getElementById('legend');
            legend.style.display = legend.style.display === 'none' ? 'block' : 'none';
        }

        // Export data
        function exportData() {
            // This would export current map data
            alert('T√≠nh nƒÉng xu·∫•t d·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t trong phi√™n b·∫£n ti·∫øp theo');
        }

        // Show/hide loading
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Initialize map when page loads
        window.addEventListener('load', function() {
            initMap();
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeInfoPanel();
            }
        });

    </script>

    <!-- Google Maps API (Optional - for additional features) -->
    <!-- Uncomment and add your API key if needed -->
    <!--
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=geometry,drawing">
    </script>
    -->
</body>
</html>
